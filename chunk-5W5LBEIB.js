import{A as b,D as x,G as I,J as N,M as j,O as E,P as k,Q as R,a as h,b as l,e as v,h as U,m,n as $,p,r as O,sb as J,u as T}from"./chunk-65IBRMVV.js";var S=new E("FIREBASE_CONFIG"),C=r=>({provide:S,useValue:r});var f=class extends Error{constructor(n,o,e){super(o,e),this.code=n,this.message=o}};var g=class extends Error{},w;(function(r){let n="https://identitytoolkit.googleapis.com/v1/accounts:signUp";class o extends f{}r.ResponseError=o;function e(t,i){return v(this,null,function*(){let a=l(h({},i),{returnSecureToken:!0});try{let s=yield fetch(`${n}?key=${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),c=yield s.json();if(s.ok)return c;{let{error:{code:u,message:d}}=c;throw new o(u,d)}}catch(s){throw s instanceof o?s:new g(JSON.stringify(s))}})}r.request=e})(w||(w={}));var _;(function(r){let n="https://identitytoolkit.googleapis.com/v1/accounts:signInWithPassword";class o extends f{}r.ResponseError=o;function e(t,i){return v(this,null,function*(){let a=l(h({},i),{returnSecureToken:!0});try{let s=yield fetch(`${n}?key=${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),c=yield s.json();if(s.ok)return c;{let{error:{code:u,message:d}}=c;throw new o(u,d)}}catch(s){throw s instanceof o?s:new g(JSON.stringify(s))}})}r.request=e})(_||(_={}));var y;(function(r){let n="https://securetoken.googleapis.com/v1/token";class o extends f{}r.ResponseError=o;function e(t,i){return v(this,null,function*(){let a={grant_type:"refresh_token",refresh_token:i};try{let s=yield fetch(`${n}?key=${t}`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(a).toString()}),c=yield s.json();if(s.ok)return c;{let{error:{code:u,message:d}}=c;throw new o(u,d)}}catch(s){throw s instanceof o?s:new g(JSON.stringify(s))}})}r.request=e})(y||(y={}));function X(r,n){return r.url.match(/^https:\/\/(?:www\.)?(?:.+?firebaseio|firebasestorage\.googleapis\.com)/)?n(r):R(A).authToken().pipe(I(e=>{if(e){let t=r.clone({params:r.params.append("access_token",e)});return n(t)}else return n(r)}))}var A=(()=>{let n=class n{constructor(e,t){this.config=e,this.http=t;let i=localStorage.getItem("appUsers");this._users$=new U(i&&JSON.parse(i)||{}),this.usersArray$=this._users$.pipe(p(s=>Object.values(s)));let a=localStorage.getItem("appActiveUserId");this._activeUser$=new U(a&&this._users$.value[a]||null),this._storageSubscription=O(window,"storage").pipe(T(s=>s.key==="appUsers"&&s.newValue!==s.oldValue),p(({newValue:s})=>s&&JSON.parse(s)||{})).subscribe(s=>{this._users$.next(s);let c=this._activeUser$.value,u=c&&s[c.id];JSON.stringify(u)!==JSON.stringify(c)&&this._activeUser$.next(u??null)})}ngOnDestroy(){this._storageSubscription.unsubscribe(),this._activeUser$.complete(),this._users$.complete()}get activeUser(){return this._activeUser$.value}get activeUser$(){return this._activeUser$.asObservable()}get users(){return this._users$.value}get users$(){return this._users$.asObservable()}authToken(){let e=this.activeUser;return e?.auth?this._newAuthToken$?this._newAuthToken$:Date.now()-5*60*1e3-e.auth.expiresOn<=0?(this._newAuthToken$=m(y.request(this.config.apiKey,e.auth.refreshToken)).pipe(N(t=>this._setUser(l(h({},e),{auth:{authToken:t.id_token,expiresOn:Date.now()+1e3*Number(t.expires_in),refreshToken:t.refresh_token}}))),p(t=>t.id_token),b(()=>this._newAuthToken$=void 0),x()),this._newAuthToken$):$(e.auth.authToken):$(null)}_setUser(e){let t=l(h({},this._users$.value),{[e.id]:e});this._users$.next(t),localStorage.setItem("appUsers",JSON.stringify(l(h({},this._users$.value),{[e.id]:e})))}_delUser(e){if(this._users$.value[e]){let t=h({},this._users$.value);delete t[e],localStorage.setItem("appUsers",JSON.stringify(t))}}activateUser(e){if(e!==this._activeUser$.value?.id){let t=this._users$.value[e];t&&this._activeUser$.next(t)}}deactivateUser(){this._activeUser$.value!==null&&this._activeUser$.next(null)}_signResponseToUserData(e){return{id:e.localId,email:e.email,name:e.displayName,auth:{authToken:e.idToken,expiresOn:Date.now()+1e3*Number(e.expiresIn),refreshToken:e.refreshToken}}}singUp(e,t,i){return m(w.request(this.config.apiKey,{displayName:e,email:t,password:i})).pipe(p(a=>this._signResponseToUserData(a)),p(a=>{this._setUser(a),this.activateUser(a.id)}))}signIn(e,t){return m(_.request(this.config.apiKey,{email:e,password:t})).pipe(p(i=>this._signResponseToUserData(i)),p(i=>{this._setUser(i),this.activateUser(i.id)}))}};n.\u0275fac=function(t){return new(t||n)(k(S),k(J))},n.\u0275prov=j({token:n,factory:n.\u0275fac,providedIn:"root"});let r=n;return r})();export{S as a,C as b,f as c,X as d,A as e};
